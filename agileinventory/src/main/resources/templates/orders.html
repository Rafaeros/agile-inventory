<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" th:href="@{/img/favicon.ico}">
    <link th:href="@{/css/main.css}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <title>Ordem de Produção</title>
</head>

<body class="bg-gray-100 text-center">

    <!-- Navbar -->
    <div th:insert="~{fragments/header :: header}"></div>

    <div th:if="${warning != null}" class="bg-red-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative" role="alert">
        <span th:text="${warning}"></span>
    </div>

    <div th:if="${error != null}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <span th:text="${error}"></span>
    </div>
    
    <div th:if="${success != null}" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
        <span th:text="${success}"></span>
    </div>

    <!-- Conteúdo Principal -->
    <div class="flex flex-col items-center justify-start mt-10 w-full gap-5">

        <div class="header w-full px-15 flex items-center justify-start gap-10 mb-5">
            <h3 class="text-2xl font-bold">Ordem de Produção</h3>
            <button id="add-order-btn" onclick="openModal()"
                class="bg-purple-500 text-white w-50 h-20 font-bold text-2xl flex items-center justify-center rounded-lg hover:bg-purple-600 transition duration-300">Adicionar</button>
        </div>

        <p th:if="${message != null}" class="text-xl" th:text="${message}"></p>
        
        <ul th:if="${orders != null}" class="w-full max-h-[70vh] overflow-y-auto flex flex-col items-center gap-5 px-10">
            <!-- Loop de Ordens -->
            <li th:each="order : ${orders}" th:id="'order-' + ${order.id}"
                class="w-full bg-white p-5 rounded shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col gap-3">

                <!-- Cabeçalho da Ordem -->
                <div class="flex flex-row items-center justify-between w-full">
                    <div class="flex flex-row items-center justify-between w-full gap-10">
                        <span class="font-bold text-3xl" th:text="${order.orderNumber}"></span>
                        <span class="font-bold text-3xl" th:text="${order.product?.code}"></span>
                        <span class="font-bold text-3xl">Quantidade:
                            <span th:text="${order.quantity}"></span> PÇS
                        </span>
                    </div>
                   <button 
                        class="ml-4 cursor-pointer transform transition-transform duration-300" 
                        th:attr="data-dropdown='drop-' + ${order.id}">
                        <img 
                        th:src="@{/img/down-arrow.png}" 
                        alt="Mostrar"
                        class="h-8 w-8 transition-transform duration-300">
                    </button>
                </div>

                <!-- Dropdown da Tabela de Materiais -->
                <div th:id="'drop-' + ${order.id}"
                    class="hidden w-full bg-gray-50 p-5 rounded-lg shadow-inner transition-all duration-300">
                    <h3 class="text-center text-xl font-bold text-gray-700 mb-3"
                        th:text="'Materiais da Ordem #' + ${order.orderNumber}">
                    </h3>

                    <table class="w-full border-collapse rounded-lg  shadow-sm">
                        <thead class="bg-purple-100 text-gray-700 border-b-2">
                            <tr>
                                <th class="p-3 align-middle font-semibold">Código</th>
                                <th class="p-3 align-middle font-semibold">Descrição</th>
                                <th class="p-3 align-middle font-semibold">Quantidade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="material : ${order.materials}"
                                class="bg-white border-b hover:bg-gray-50 transition">
                                <td class="p-3 font-bold text-gray-800 text-lg" th:text="${material?.material?.code}"></td>
                                <td class="p-3 text-gray-600 text-lg" th:text="${material?.material?.description}"></td>
                                <td class="p-3 text-gray-600 text-lg text-right"
                                    th:text="${material?.quantity != null ? 'Quantidade: ' + #numbers.formatDecimal(material.quantity, 2, 2) + ' UND.' : 'Quantidade 0 UND.'}">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </li>
        </ul>
    </div>

    <!-- Modal -->
    <div id="add-order-modal" class="modal fixed inset-0 z-50 hidden items-center mt-5 justify-center h-full w-full overflow-y-auto"
        aria-hidden="true" aria-labelledby="modal-title" role="dialog">
        <div id="backdrop" class="absolute h-full w-full inset-0 bg-black/60 transition-opacity"></div>

        <div class="fixed inset-0 flex justify-center items-center h-80 mt-20 w-full p-4">
            <div id="modal-panel" class="bg-white rounded-2xl h-full w-3/4 shadow-xl mx-auto transform transition-all"
                role="document" tabindex="-1">

                <!--Header-->
                <div class="p-6 border-b flex flex-row items-center justify-between">

                    <h2 id="modal-title" class="text-lg font-semibold text-gray-800">Adicionar Ordem de Produção</h2>

                    <button id="close-modal" type="button" onclick="closeModal()" class="cursor-pointer">
                        <img th:src="@{/img/close.png}" alt="Fechar" class="h-6 w-6">
                    </button>
                </div>

                <!-- Form de busca -->
                <div id="search-section">
                    <form th:action="@{/orders/search}" method="get"
                        class="flex flex-row items-center justify-center m-2 w-full  gap-5" id="search-form">
                        <input name="orderId" type="number" id="searchInput"
                            class="w-6/12 h-10 border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"
                            placeholder="ID da Ordem de Produção" />
                        <button id="searchBtn"
                            class="flex items-center justify-center p-3 bg-purple-600 text-white font-bold rounded-md hover:bg-purple-700 transition-colors cursor-pointer">
                            <img th:src="@{/img/search.png}" alt="Procurar" class="h-6 w-6">
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/orders.js}"></script>
</body>

</html>
